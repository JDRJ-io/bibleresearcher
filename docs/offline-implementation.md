# Offline Implementation (2025‑07)

The PWA delivers full read access offline **after the first visit** and safely queues user edits for later sync.

## 1. What is cached offline?

| Bucket | Strategy | TTL |
|--------|----------|-----|
| Shell assets (`*.js`, `*.css`, fonts) | *precache* (Workbox) | Forever |
| Translation slices (signed URLs) | *CacheFirst* | 30 days |
| Cross‑ref & prophecy offsets | *CacheFirst* | 30 days |
| User data (bookmarks, highlights) | Dexie (IndexedDB) | Until user clears storage |


## 2. Queue sync workflow
offline mutation  →  queued_mutations
     ↑                  │
user online? ── no ──┐  │
     │               │  │
     └── yes ─► queueSync.ts
                      │
             Supabase RPC (insert/update)


.
Conflicts resolved via updated_at compare; local diff stored to pending_merges (future UI).

## 3. Service Worker details
Generated by vite-plugin-pwa

Runtime caching route:

js
Copy
registerRoute(
  ({url}) => url.pathname.startsWith('/storage/v1/object/public/anointed/'),
  new CacheFirst({ cacheName: 'bible-files', plugins: [
    new ExpirationPlugin({ maxAgeSeconds: 60*60*24*30 })
  ]})
);
Background sync plugin replays queued_mutations POSTs when online.

## 4. Manual test
Visit /bible?ref=John.3.

Toggle airplane mode.

Refresh → verse text appears (cached slice).

Add a bookmark.

Re‑enable network → toast “1 queued bookmark synced”.

All offline scenarios are covered by offline.spec.ts and cypress/e2e/scroll.spec.ts.

## 5. Dexie schema (offlineDB.ts)

```ts
db.version(1).stores({
  bookmarks: 'id, user_id, verse_key, name, color',
  highlights: 'id, user_id, verse_key, start_char, end_char, color',
  queued_mutations: 'id, type, payload, queued_at',
});
---